import { useState } from 'react';
import { ethers } from 'ethers';
import { useWallets } from '@privy-io/react-auth';

// TokenRegistry bytecode (from contracts/TokenRegistry.json)
const TokenRegistryBytecode = `0x6080604052348015600e575f5ffd5b50611c378061001c5f395ff3fe608060405234801561000f575f5ffd5b5060043610610091575f3560e01c8063dd267e3a11610064578063dd267e3a14610144578063ecc4873514610174578063f08b82e6146101a5578063f5dab711146101c3578063f7134fe9146101f957610091565b80631dcdaceb146100955780632a5c792a146100c5578063634282af146100e4578063c3c5a54714610114575b5f5ffd5b6100af60048036038101906100aa91906110e5565b610215565b6040516100bc9190611128565b60405180910390f35b6100cd61025e565b6040516100db9291906113ed565b60405180910390f35b6100fe60048036038101906100f9919061144c565b6105d6565b60405161010b9190611486565b60405180910390f35b61012e600480360381019061012991906110e5565b610610565b60405161013b91906114b9565b60405180910390f35b61015e600480360381019061015991906114d2565b61062d565b60405161016b9190611486565b60405180910390f35b61018e600480360381019061018991906110e5565b610675565b60405161019c9291906113ed565b60405180910390f35b6101ad610a2a565b6040516101ba9190611128565b60405180910390f35b6101dd60048036038101906101d891906110e5565b610a35565b6040516101f09796959493929190611567565b60405180910390f35b610213600480360381019061020e9190611738565b610bc9565b005b5f60025f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20805490509050919050565b6060805f8054806020026020016040519081016040528092919081815260200182805480156102df57602002820191905f5260205f20905b815f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610296575b50505050509150815167ffffffffffffffff811115610301576103006115ea565b5b60405190808252806020026020018201604052801561033a57816020015b610327611013565b81526020019060019003908161031f5790505b5090505f5f90505b82518110156105d15760015f848381518110610361576103606117e7565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206040518060e00160405290815f82015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001600182015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160028201805461046690611841565b80601f016020809104026020016040519081016040528092919081815260200182805461049290611841565b80156104dd5780601f106104b4576101008083540402835291602001916104dd565b820191905f5260205f20905b8154815290600101906020018083116104c057829003601f168201915b505050505081526020016003820180546104f690611841565b80601f016020809104026020016040519081016040528092919081815260200182805461052290611841565b801561056d5780601f106105445761010080835404028352916020019161056d565b820191905f5260205f20905b81548152906001019060200180831161055057829003601f168201915b50505050508152602001600482015f9054906101000a900460ff1660ff1660ff168152602001600582015481526020016006820154815250508282815181106105b9576105b86117e7565b5b60200260200101819052508080600101915050610342565b509091565b5f81815481106105e4575f80fd5b905f5260205f20015f915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6003602052805f5260405f205f915054906101000a900460ff1681565b6002602052815f5260405f208181548110610646575f80fd5b905f5260205f20015f915091509054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60608060025f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2080548060200260200160405190810160405280929190818152602001828054801561073257602002820191905f5260205f20905b815f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190600101908083116106e9575b50505050509150815167ffffffffffffffff811115610754576107536115ea565b5b60405190808252806020026020018201604052801561078d57816020015b61077a611013565b8152602001906001900390816107725790505b5090505f5f90505b8251811015610a245760015f8483815181106107b4576107b36117e7565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f206040518060e00160405290815f82015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001600182015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016002820180546108b990611841565b80601f01602080910402602001604051908101604052809291908181526020018280546108e590611841565b80156109305780601f1061090757610100808354040283529160200191610930565b820191905f5260205f20905b81548152906001019060200180831161091357829003601f168201915b5050505050815260200160038201805461094990611841565b80601f016020809104026020016040519081016040528092919081815260200182805461097590611841565b80156109c05780601f10610997576101008083540402835291602001916109c0565b820191905f5260205f20905b8154815290600101906020018083116109a357829003601f168201915b50505050508152602001600482015f9054906101000a900460ff1660ff1660ff16815260200160058201548152602001600682015481525050828281518110610a0c57610a0b6117e7565b5b60200260200101819052508080600101915050610795565b50915091565b5f5f80549050905090565b6001602052805f5260405f205f91509050805f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690806001015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690806002018054610a9e90611841565b80601f0160208091040260200160405190810160405280929190818152602001828054610aca90611841565b8015610b155780601f10610aec57610100808354040283529160200191610b15565b820191905f5260205f20905b815481529060010190602001808311610af857829003601f168201915b505050505090806003018054610b2a90611841565b80601f0160208091040260200160405190810160405280929190818152602001828054610b5690611841565b8015610ba15780601f10610b7857610100808354040283529160200191610ba1565b820191905f5260205f20905b815481529060010190602001808311610b8457829003601f168201915b505050505090806004015f9054906101000a900460ff16908060050154908060060154905087565b5f73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff1603610c37576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c2e906118bb565b60405180910390fd5b60035f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f9054906101000a900460ff1615610cc1576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cb890611923565b60405180910390fd5b5f6040518060e001604052808773ffffffffffffffffffffffffffffffffffffffff1681526020013373ffffffffffffffffffffffffffffffffffffffff1681526020018681526020018581526020018460ff1681526020018381526020014281525090508060015f8873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f820151815f015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151816001015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506040820151816002019081610e039190611ae1565b506060820151816003019081610e199190611ae1565b506080820151816004015f6101000a81548160ff021916908360ff16021790555060a0820151816005015560c08201518160060155905050600160035f8873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f6101000a81548160ff0219169083151502179055505f86908060018154018082558091505060019003905f5260205f20015f9091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060025f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2086908060018154018082558091505060019003905f5260205f20015f9091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055503373ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff167f1388e2ed90c5fb7818c094c1326174a8ffe9861aad3def62dfeebf6a039edc21878787876040516110039493929190611bb0565b60405180910390a3505050505050565b6040518060e001604052805f73ffffffffffffffffffffffffffffffffffffffff1681526020015f73ffffffffffffffffffffffffffffffffffffffff16815260200160608152602001606081526020015f60ff1681526020015f81526020015f81525090565b5f604051905090565b5f5ffd5b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6110b48261108b565b9050919050565b6110c4816110aa565b81146110ce575f5ffd5b50565b5f813590506110df816110bb565b92915050565b5f602082840312156110fa576110f9611083565b5b5f611107848285016110d1565b91505092915050565b5f819050919050565b61112281611110565b82525050565b5f60208201905061113b5f830184611119565b92915050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b611173816110aa565b82525050565b5f611184838361116a565b60208301905092915050565b5f602082019050919050565b5f6111a682611141565b6111b0818561114b565b93506111bb8361115b565b805f5b838110156111eb5781516111d28882611179565b97506111dd83611190565b9250506001810190506111be565b5085935050505092915050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61126382611221565b61126d818561122b565b935061127d81856020860161123b565b61128681611249565b840191505092915050565b5f60ff82169050919050565b6112a681611291565b82525050565b6112b581611110565b82525050565b5f60e083015f8301516112d05f86018261116a565b5060208301516112e3602086018261116a565b50604083015184820360408601526112fb8282611259565b915050606083015184820360608601526113158282611259565b915050608083015161132a608086018261129d565b5060a083015161133d60a08601826112ac565b5060c083015161135060c08601826112ac565b508091505092915050565b5f61136683836112bb565b905092915050565b5f602082019050919050565b5f611384826111f8565b61138e8185611202565b9350836020820285016113a085611212565b805f5b858110156113db57848403895281516113bc858261135b565b94506113c78361136e565b925060208a019950506001810190506113a3565b50829750879550505050505092915050565b5f6040820190508181035f830152611405818561119c565b90508181036020830152611419818461137a565b90509392505050565b61142b81611110565b8114611435575f5ffd5b50565b5f8135905061144681611422565b92915050565b5f6020828403121561146157611460611083565b5b5f61146e84828501611438565b91505092915050565b611480816110aa565b82525050565b5f6020820190506114995f830184611477565b92915050565b5f8115159050919050565b6114b38161149f565b82525050565b5f6020820190506114cc5f8301846114aa565b92915050565b5f5f604083850312156114e8576114e7611083565b5b5f6114f5858286016110d1565b925050602061150685828601611438565b9150509250929050565b5f82825260208201905092915050565b5f61152a82611221565b6115348185611510565b935061154481856020860161123b565b61154d81611249565b840191505092915050565b61156181611291565b82525050565b5f60e08201905061157a5f83018a611477565b6115876020830189611477565b81810360408301526115998188611520565b905081810360608301526115ad8187611520565b90506115bc6080830186611558565b6115c960a0830185611119565b6115d660c0830184611119565b98975050505050505050565b5f5ffd5b5f5ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b61162082611249565b810181811067ffffffffffffffff8211171561163f5761163e6115ea565b5b80604052505050565b5f61165161107a565b905061165d8282611617565b919050565b5f67ffffffffffffffff82111561167c5761167b6115ea565b5b61168582611249565b9050602081019050919050565b828183375f83830152505050565b5f6116b26116ad84611662565b611648565b9050828152602081018484840111156116ce576116cd6115e6565b5b6116d9848285611692565b509392505050565b5f82601f8301126116f5576116f46115e2565b5b81356117058482602086016116a0565b91505092915050565b61171781611291565b8114611721575f5ffd5b50565b5f813590506117328161170e565b92915050565b5f5f5f5f5f60a0868803121561175157611750611083565b5b5f61175e888289016110d1565b955050602086013567ffffffffffffffff81111561177f5761177e611087565b5b61178b888289016116e1565b945050604086013567ffffffffffffffff8111156117ac576117ab611087565b5b6117b8888289016116e1565b93505060606117c988828901611724565b92505060806117da88828901611438565b9150509295509295909350565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061185857607f821691505b60208210810361186b5761186a611814565b5b50919050565b7f496e76616c696420746f6b656e206164647265737300000000000000000000005f82015250565b5f6118a5601583611510565b91506118b082611871565b602082019050919050565b5f6020820190508181035f8301526118d281611899565b9050919050565b7f546f6b656e20616c7265616479207265676973746572656400000000000000005f82015250565b5f61190d601883611510565b9150611918826118d9565b602082019050919050565b5f6020820190508181035f83015261193a81611901565b9050919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f6008830261199d7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82611962565b6119a78683611962565b95508019841693508086168417925050509392505050565b5f819050919050565b5f6119e26119dd6119d884611110565b6119bf565b611110565b9050919050565b5f819050919050565b6119fb836119c8565b611a0f611a07826119e9565b84845461196e565b825550505050565b5f5f905090565b611a26611a17565b611a318184846119f2565b505050565b5b81811015611a5457611a495f82611a1e565b600181019050611a37565b5050565b601f821115611a9957611a6a81611941565b611a7384611953565b81016020851015611a82578190505b611a96611a8e85611953565b830182611a36565b50505b505050565b5f82821c905092915050565b5f611ab95f1984600802611a9e565b1980831691505092915050565b5f611ad18383611aaa565b9150826002028217905092915050565b611aea82611221565b67ffffffffffffffff811115611b0357611b026115ea565b5b611b0d8254611841565b611b18828285611a58565b5f60209050601f831160018114611b49575f8415611b37578287015190505b611b418582611ac6565b865550611ba8565b601f198416611b5786611941565b5f5b82811015611b7e57848901518255600182019150602085019450602081019050611b59565b86831015611b9b5784890151611b97601f891682611aaa565b8355505b6001600288020188555050505b505050505050565b5f6080820190508181035f830152611bc88187611520565b90508181036020830152611bdc8186611520565b9050611beb6040830185611558565b611bf86060830184611119565b9594505050505056fea26469706673582212206c9a4933e0ed15b6da42a279882ccbb3d19ca7b86ac4d712a0593cd1256db56964736f6c634300081e0033`;

export default function DeployRegistry() {
  const { wallets } = useWallets();
  const embeddedWallet = wallets.find(w => w.walletClientType === 'privy');
  
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [deployedAddress, setDeployedAddress] = useState('');
  const [registryAddress, setRegistryAddress] = useState(localStorage.getItem('registryAddress') || '');

  const deployRegistry = async () => {
    if (!embeddedWallet) {
      setError('Please connect wallet first');
      return;
    }

    setLoading(true);
    setError('');
    setDeployedAddress('');

    try {
      const provider = await embeddedWallet.getEthereumProvider();
      const ethersProvider = new ethers.BrowserProvider(provider);
      const signer = await ethersProvider.getSigner();
      
      console.log('ğŸ“¦ Deploying TokenRegistry...');
      const tx = await signer.sendTransaction({
        data: TokenRegistryBytecode,
      });

      console.log(`ğŸ“ Transaction submitted: ${tx.hash}`);
      const receipt = await tx.wait();
      console.log(`âœ… TokenRegistry deployed at: ${receipt!.contractAddress}`);
      
      const contractAddress = receipt!.contractAddress!;
      setDeployedAddress(contractAddress);
      setRegistryAddress(contractAddress);
      localStorage.setItem('registryAddress', contractAddress);
      
    } catch (err: any) {
      console.error('âŒ Error deploying TokenRegistry:', err);
      setError(`Failed to deploy TokenRegistry: ${err.message}`);
    } finally {
      setLoading(false);
    }
  };

  if (!embeddedWallet) {
    return null;
  }

  if (registryAddress && ethers.isAddress(registryAddress)) {
    return (
      <div style={{ 
        marginTop: '2rem', 
        padding: '1rem', 
        background: '#f0f7ff', 
        borderRadius: '8px',
        border: '1px solid #b3d9ff'
      }}>
        <div style={{ fontSize: '1rem', fontWeight: 600, marginBottom: '0.5rem' }}>
          âœ… TokenRegistry is configured
        </div>
        <div style={{ fontFamily: 'monospace', fontSize: '0.9rem', color: '#666', marginBottom: '0.5rem' }}>
          {registryAddress}
        </div>
        <button
          onClick={() => {
            navigator.clipboard.writeText(registryAddress);
          }}
          style={{
            padding: '0.5rem 1rem',
            fontSize: '0.85rem',
            background: '#e0e0e0',
            color: '#333',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer'
          }}
        >
          ğŸ“‹ Copy Address
        </button>
      </div>
    );
  }

  return (
    <div style={{ 
      marginTop: '2rem', 
      padding: '1rem', 
      background: '#fff3cd', 
      borderRadius: '8px',
      border: '1px solid #ffc107'
    }}>
      <div style={{ fontSize: '1rem', fontWeight: 600, marginBottom: '0.5rem' }}>
        ğŸ“‹ Deploy TokenRegistry
      </div>
      <div style={{ fontSize: '0.9rem', color: '#666', marginBottom: '1rem' }}>
        Deploy TokenRegistry contract to track all tokens on-chain. This enables marketplace and trading features.
      </div>
      
      {error && (
        <div style={{ 
          marginBottom: '1rem', 
          padding: '0.75rem', 
          background: '#fee',
          borderLeft: '4px solid #e00',
          borderRadius: '4px',
          color: '#c00',
          fontSize: '0.9rem'
        }}>
          <strong>Error:</strong> {error}
        </div>
      )}

      {deployedAddress && (
        <div style={{ 
          marginBottom: '1rem', 
          padding: '1rem', 
          background: '#efe',
          borderLeft: '4px solid #0e0',
          borderRadius: '4px',
          color: '#0a0'
        }}>
          <strong>âœ… TokenRegistry Deployed Successfully!</strong>
          <div style={{ marginTop: '0.75rem', fontFamily: 'monospace', fontSize: '0.9rem' }}>
            <strong>Address:</strong><br />
            {deployedAddress}
          </div>
          <div style={{ marginTop: '0.75rem' }}>
            <a 
              href={`https://testnet.arcscan.app/address/${deployedAddress}`}
              target="_blank"
              rel="noopener noreferrer"
              style={{ color: '#667eea', textDecoration: 'none', fontSize: '0.9rem', fontWeight: 600 }}
            >
              View on Arcscan â†’
            </a>
          </div>
          <div style={{ marginTop: '0.5rem', fontSize: '0.85rem', color: '#666' }}>
            This address will be automatically used when deploying tokens below
          </div>
        </div>
      )}

      <button 
        onClick={deployRegistry}
        disabled={loading || !!deployedAddress}
        style={{ 
          padding: '0.75rem 1.5rem', 
          fontSize: '1rem',
          background: loading || deployedAddress ? '#ccc' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          color: 'white',
          border: 'none',
          borderRadius: '8px',
          cursor: loading || deployedAddress ? 'not-allowed' : 'pointer',
          fontWeight: 600
        }}
      >
        {loading ? 'ğŸ”„ Deploying...' : deployedAddress ? 'âœ… Deployed' : 'ğŸš€ Deploy TokenRegistry'}
      </button>
    </div>
  );
}

